Delimiter //
create procedure addPessoa(_id_pessoa int(11), _nome varchar(50), _apelido varchar(30),
_data_nascimento date, _sexo enum('M','F'), _estado_civil enum('S','C'),
_numero_telf int(11), _email varchar(50))
Begin
	insert into pessoa (id_pessoa, nomes,apelido,data_nascimento, sexo, estado_civil,
	numero_telf,email, data_cadastro) values (_id_pessoa, _nome,apelido,_data_nascimento, _sexo, _estado_civil,
	_numero_telf, _email,curdate());  
end;
//


call addCandidato(4,'Ricardo Orlando','Manhice','2013-09-09','M',
'9','Diurno','Escola Secundaria Quisse Mavota','kamubukwana');

Call addAluno_matriculado ('Manhice','Ricardo Orlando','Mocambique','Cidade de Maputo','kamubukwana','1998-09-09','1990A797P090C','Cidade de Maputo','2018-09-12','M','S',
'Cidade de Maputo','kamubukwana','Jorge Dimitrov','Av. de Mocambique','46',48,843029480,'E_tit_u','Marcio',840788118,'Cidade de Maputo','Pedreiro','Marta',
842093842,'Cidade de Maputo','Domestica','Marcio',840788118,'Cidade de Maputo','kamubukwana','Jorge Dimitrov','Av. de Mocambique','Cidade de Maputo','Pedreiro');


Delimiter //
Create procedure addAluno_matriculado(_apelido varchar(30),_nomes varchar(50),
_pais_nas varchar(50),_provincia_nas varchar(50),_distrito_nas varchar(50),
_data_nascimento date,_bi varchar(13),_local_emissao varchar(50),_data_em date,
_sexo enum('M','F'),_estado_civil enum('S','C'),
_provincia_res varchar(50),_distrito_res varchar(50),_bairro varchar(50),
_av_ou_rua varchar(50),_quarteirao varchar(50),_nr_casa int,_numero_telf int,_email varchar(50),
_nome_pai varchar(50),_telefone_pai int,_local_trabalho_pai varchar(50),
_profissao_pai varchar(50),_nome_mae varchar(50),_telefone_mae int,
_local_trabalho_mae varchar(50),_profissao_mae varchar(50),
_nome_enc varchar(50),_numero_tf_enc int,_provincia_enc varchar(50),
_distrito_enc varchar(50),_bairro_enc varchar(50),_av_ou_rua_enc varchar(50),
_local_trab_enc varchar(50),_profissao_enc varchar(50))
Begin
	declare idp_p int; 
	declare idp_p_t int; 
	declare id_bair_enc int;
	declare id_bair_al int;
	declare id_enc int;
	declare id_nat int;
	declare id_al int;
	declare id_matr int;
	declare id_cand int;	
	declare clas varchar(5);
	declare id_clas int;
	declare turn enum('diurno','nocturno');

	Start transaction;
	Select id_pessoa into idp_p_t from pessoa where apelido=_apelido and nomes=_nomes; 
	if (idp_p_t is not null) then
		Select "Este Aluno ja esta registado" as Mensagem;
	else
		Begin
			Select id_candidato into id_cand from candidato_aluno where nome=_nomes and apelido=_apelido;
 			Select classe_matricular into clas from candidato_aluno where nome=_nomes and apelido=_apelido;
			Select regime into turn from candidato_aluno where nome=_nomes and apelido=_apelido;
 
			Call addPessoa(5,_nomes,_apelido,_data_nascimento,_sexo, 
			_estado_civil,_numero_telf,_email);
	
			Select id_pessoa into idp_p from pessoa where apelido=_apelido and nomes=_nomes;
	
			if(idp_p is not null) then
				Begin
					Select id_distrito into id_nat from distrito where nome_distrito=_distrito_nas;
					Insert into aluno (id_aluno,id_pessoa,id_natural) values (1,idp_p,id_nat);
					Select id_aluno into id_al from aluno where id_pessoa=idp_p;
					if(id_al is not null) then
						begin 
							Select id_bairro into id_bair_al from bairro where nome_bairro=_bairro;
							Insert into residencia_aluno (id_aluno,id_bairro,av_ou_rua,quarteirao,nr_casa) values (id_al,id_bair_al,_av_ou_rua,_quarteirao,_nr_casa);
							Insert into aluno_candidato (id_aluno,id_candidato,estado,data) values (id_al,id_cand,'candidato',curdate());			
							Select id_classe into id_clas from classe where classe=clas and turno=turn;
							Insert into aluno_classe (id_aluno,id_classe,ano) values (id_al,id_clas,year(curdate()));
							Select id_matricula into id_matr from matricula where data_fim>=curdate();
							Insert into aluno_matricula (id_aluno,id_matricula,estado) value (id_al,id_matr,default);
							Insert into bi (id_aluno,numero_bi,data_emissao,local_emissao) values (id_al,_bi,_data_em,_local_emissao);
							Insert into filiacao (id_filiacao,id_aluno,nome_pai,telefone_pai,local_trabalho_pai,profissao_pai,nome_mae,telefone_mae,local_trabalho_mae,profissao_mae) values (default,id_al,_nome_pai,_telefone_pai,_local_trabalho_pai,_profissao_pai,_nome_mae,_telefone_mae,_local_trabalho_mae,_profissao_mae);
							Insert into encarregado (id_encarregado,id_aluno,nome_completo,numero_telefone,local_trabalho,profissao) values (default,id_al,_nome_enc,_numero_tf_enc,_local_trab_enc,_profissao_enc);	
							Select id_encarregado into id_enc from encarregado where id_aluno=id_al;
							Select id_bairro into id_bair_enc from bairro where nome_bairro=_bairro_enc; 
							Insert into residencia_encarregado (id_encarregado,id_bairro,av_ou_rua) values (id_enc,id_bair_enc,_av_ou_rua_enc);
							commit;
						end;
					else
						Begin
							Select 'Erro no id_al' as Mensagem;
							rollback;
						End;	
					end if;
				end;

			else
				Begin
					Select 'Erro no idP_p' as Mensagem;
					rollback;
				End;
			end if;		
		End;
	End if; 
	
end; //
			

















			